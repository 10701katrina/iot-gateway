# 🤝 TCP 三次握手 (Three-Way Handshake)

> **核心概念**：这是 TCP 协议建立连接的必经过程。在传输数据前，双方必须确认“**我们要开始通话了，你准备好了吗？**”。如果不握手，数据发过去可能对方根本没开机，连接就是不可靠的。

---

## 1. 通俗比喻：特工对暗号 🕵️‍♂️

想象特工 A（客户端）要给特工 B（服务器）打电话。

* **第一次握手 (A -> B)**：
    * **A 喊话**：“喂？我是 A，你能听到我说话吗？”
    * *(潜台词：请求建立连接)*
* **第二次握手 (B -> A)**：
    * **B 回复**：“听到了！我是 B，我也能听到你。你能听到我吗？”
    * *(潜台词：同意连接 + 我也要确认你的听力)*
* **第三次握手 (A -> B)**：
    * **A 回复**：“我也听到了！那我们要开始说正事了。”
    * *(潜台词：双向确认完毕，连接正式建立)*

**💥 只有这三步走完，双方才确认：我也能发，你也能收；我也能收，你也能发。**

---

## 2. 技术原理图解 🛠️

这是通过 TCP 包头里的 **标志位 (Flags)** 实现的。

```text
Client (客户端)                       Server (服务器)
[CLOSED]                                [LISTEN]
   |                                       |
   | 1. SYN (seq=x)                        |
   |-------------------------------------->|
   | [SYN_SENT]                            |
   |                                       | 2. SYN + ACK (seq=y, ack=x+1)
   |<--------------------------------------|
   |                                       | [SYN_RCVD]
   | 3. ACK (ack=y+1)                      |
   |-------------------------------------->|
   | [ESTABLISHED]                         |
   |                                       | [ESTABLISHED]
   v                                       v
(开始传输数据)                          (开始传输数据)
```
    * SYN (Synchronize)：请求同步（我要连你）。

    * ACK (Acknowledge)：确认收到（我知道了）。

    * ESTABLISHED：连接已建立状态。

1. Client 发送 SYN：

    * 客户端处于 SYN_SENT 状态。

    * 意思：我想建立连接，我的序列号是 X。

2. Server 回复 SYN + ACK：

    * 服务器处于 SYN_RCVD 状态。

    * 意思：收到你的请求（ACK=X+1），我也想连你（SYN），我的序列号是 Y。

3. Client 发送 ACK：

    * 客户端处于 ESTABLISHED (已建立) 状态。

    * 意思：收到你的请求了（ACK=Y+1）。

    * 此时，服务器收到这个包后，也进入 ESTABLISHED 状态。

## 3.三次握手发生在代码的哪里？

> **❓ 你可能会问**：“我在代码里没写发送 `SYN` 和 `ACK` 的语句啊？”
>
> **✅ 回答**：**是的，你不需要写！** 这是操作系统内核（Kernel）帮你自动完成的。

请看您的代码与内核动作的对应关系：

### 1. 准备阶段：`listen(server_fd, 3)`
* **你的动作**：执行这一行代码。
* **内核动作**：
    1.  服务器进入 **LISTEN** 状态，准备接受“第一次握手”。
    2.  当客户端发来 `SYN`（第一次握手）时，内核会自动将其放入 **半连接队列 (Syn Queue)**。

### 2. 内核自动应答 (The Magic)
* **你的动作**：*（无，你在睡觉或阻塞中）*
* **内核动作**：
    1.  内核收到 `SYN` 后，**自动回复** `SYN+ACK`（第二次握手）。
    2.  这一步完全不需要用户层代码干预。

### 3. 连接完成：客户端回 ACK
* **你的动作**：*（无）*
* **内核动作**：
    1.  当客户端的 `ACK`（第三次握手）到达服务器时。
    2.  内核把这个连接从“半连接队列”移入 **全连接队列 (Accept Queue)**。
    3.  *注意*：`listen` 函数中的参数 `3`，限制的就是这个队列的长度。

### 4. 提取连接：`accept()`
* **你的动作**：调用 `accept()`。
* **内核动作**：
    1.  这个函数的作用，仅仅是从 **全连接队列** 里，把已经完成三次握手的连接“取”出来。
    2.  将其封装成一个新的文件描述符 `client_fd` 交给你的程序。

---

### 💡 总结 (Key Takeaways)

| 概念 | 说明 |
| :--- | :--- |
| **三次握手** | 建立 TCP 连接的**全自动**过程，由 OS 内核接管。 |
| **核心目的** | 确认双方收发能力正常，同步初始序列号 (ISN)。 |
| **代码时机** | **发生在 `accept()` 返回之前**。 <br>当 `accept()` 不再阻塞并返回一个整数时，说明三次握手已经在幕后悄悄结束了。 |