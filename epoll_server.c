#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>
#include <sys/socket.h>
#include <sys/epoll.h> // ğŸ‘ˆ Epoll ä¸“å±å¤´æ–‡ä»¶

#define PORT 8888
#define MAX_EVENTS 100  // æ¯æ¬¡ epoll_wait æœ€å¤šè¿”å›å¤šå°‘ä¸ªå°±ç»ªäº‹ä»¶
#define BUFFER_SIZE 1024



int main() {
    int server_fd, client_fd, epoll_fd;
    struct sockaddr_in address;
    int addr_len = sizeof(address);
    char buffer[BUFFER_SIZE];

    // --- 1. åŸºç¡€æ­å»º (ä¹°æ‰‹æœºã€æ’å¡ã€ç­‰ç”µè¯) ---
    // è¿™éƒ¨åˆ†å’Œ simple_server ä¸€æ¨¡ä¸€æ ·
    if ((server_fd = socket(AF_INET, SOCK_STREAM, 0)) < 0) {
        perror("Socket creation failed");
        exit(EXIT_FAILURE);
    }
    
    // ç«¯å£å¤ç”¨ (è§£å†³ Address already in use)
    int opt = 1;//// 1 ä»£è¡¨â€œçœŸâ€ (True/Enable)
    setsockopt(server_fd, SOL_SOCKET, SO_REUSEADDR, &opt, sizeof(opt));
    //setsockopt: è¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œç”¨äºä¿®æ”¹ Socket çš„å„ç§â€œé…ç½®é€‰é¡¹â€ã€‚
    //SOL_SOCKET: è¡¨ç¤ºæˆ‘ä»¬è¦æ”¹çš„æ˜¯ Socket å±‚ çš„é€šç”¨é€‰é¡¹ï¼ˆè€Œä¸æ˜¯ TCP æˆ– IP åè®®å±‚çš„é€‰é¡¹ï¼‰ã€‚
    //SO_REUSEADDR: å…è®¸é‡ç”¨æœ¬åœ°åœ°å€ï¼ˆIP åœ°å€ + ç«¯å£å·ï¼‰ã€‚è¿™æ ·å³ä½¿ä¸Šæ¬¡è¿è¡Œçš„æœåŠ¡å™¨è¿˜åœ¨ TIME_WAIT çŠ¶æ€ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½ç«‹åˆ»é‡æ–°ç»‘å®šè¿™ä¸ªç«¯å£ï¼Œé¿å…â€œAddress already in useâ€é”™è¯¯ã€‚
    //&opt: ä¼ é€’ä¸€ä¸ªæ•´æ•°å€¼ï¼Œéé›¶è¡¨ç¤ºå¯ç”¨è¯¥é€‰é¡¹ï¼Œè¿™é‡Œæˆ‘ä»¬ä¼ é€’ 1ã€‚æŒ‡å‘å€¼ 1 çš„æŒ‡é’ˆï¼Œè¡¨ç¤ºå¼€å¯è¿™ä¸ªåŠŸèƒ½ã€‚
    //sizeof(opt): ä¼ é€’é€‰é¡¹å€¼çš„å¤§å°ã€‚
    
    //ã€åœºæ™¯å¤ç°ã€‘
    //ä½ å¯åŠ¨äº†æœåŠ¡å™¨ï¼ˆç›‘å¬ 8888ï¼‰ã€‚
    //å®¢æˆ·ç«¯è¿ä¸Šæ¥äº†ã€‚
    //ä½ æŒ‰ Ctrl+C å¼ºè¡Œæ€æ‰äº†æœåŠ¡å™¨è¿›ç¨‹ã€‚
    //ä½ ç«‹åˆ»å†æ¬¡è¿è¡ŒæœåŠ¡å™¨ã€‚
    //æŠ¥é”™ï¼š bind failed: Address already in useã€‚
    //ä½ å¾—ç­‰ä¸ª 2~4 åˆ†é’Ÿï¼ŒæœåŠ¡å™¨æ‰èƒ½å†æ¬¡å¯åŠ¨ã€‚
    //ã€åŸå› ã€‘
    //æ ¹æ® TCP åè®®ï¼Œä¸»åŠ¨å…³é—­è¿æ¥çš„ä¸€æ–¹ï¼ˆè¿™é‡Œæ˜¯ä½ çš„ Server è¢« kill äº†ï¼Œç³»ç»Ÿå¸®ä½ å‘çš„ FIN åŒ…ï¼‰ï¼Œåœ¨è¿æ¥æ–­å¼€åï¼Œå¿…é¡»è¿›å…¥ä¸€ä¸ªå« TIME_WAIT çš„çŠ¶æ€ï¼ŒæŒç»­æ—¶é—´æ˜¯ 2MSLï¼ˆé€šå¸¸æ˜¯ 60ç§’ ~ 4åˆ†é’Ÿï¼‰ã€‚
    //å†…æ ¸çš„æƒ³æ³•ï¼šâ€œè™½ç„¶ç¨‹åºå…³äº†ï¼Œä½†è¿™æ ¹ç½‘çº¿ä¸Šå¯èƒ½è¿˜æœ‰åˆšæ‰æ²¡ä¼ å®Œçš„è¿·è·¯æ•°æ®åŒ…ã€‚ä¸ºäº†é˜²æ­¢è¿™äº›æ—§æ•°æ®åŒ…å¹²æ‰°ä¸‹ä¸€ä¸ªç”¨è¿™ä¸ªç«¯å£çš„æ–°ç¨‹åºï¼Œæˆ‘å¿…é¡»æŠŠè¿™ä¸ªç«¯å£å†»ç»“å‡ åˆ†é’Ÿï¼Œç­‰æ‰€æœ‰æ—§æ•°æ®æ­»é€ã€‚â€

    address.sin_family = AF_INET;
    address.sin_addr.s_addr = INADDR_ANY;
    address.sin_port = htons(PORT);

    if (bind(server_fd, (struct sockaddr *)&address, sizeof(address)) < 0) {
        perror("Bind failed");
        exit(EXIT_FAILURE);
    }

    if (listen(server_fd, 10) < 0) { // Backlog å¯ä»¥ç¨å¾®å¤§ä¸€ç‚¹
        perror("Listen failed");
        exit(EXIT_FAILURE);
    }
    
    printf("ğŸš€ Epoll Server å¯åŠ¨! æ­£åœ¨ç›‘å¬ç«¯å£ %d\n", PORT);

    // --- 2. Epoll åˆå§‹åŒ– (ä¹°é»‘æ¿) ---
    
    // åˆ›å»ºä¸€ä¸ª Epoll å®ä¾‹
    // å‚æ•° 1 æ˜¯å†å²é—ç•™ï¼Œç°åœ¨åªè¦ä¼ å¤§äº 0 çš„æ•°å³å¯ï¼Œæˆ–è€…ç”¨ epoll_create1(0)
    if ((epoll_fd = epoll_create(1)) < 0) {
        ////epoll_create() ç³»ç»Ÿè°ƒç”¨ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„ Epoll å®ä¾‹ï¼Œå¹¶è¿”å›å…¶æ–‡ä»¶æè¿°ç¬¦ï¼ˆepoll_fdï¼‰ã€‚ã€Epoll å®ä¾‹åˆ›å»ºä¸èµ„æºåˆ†é…ã€‘
        //epoll_fd æ˜¯ Epoll å®ä¾‹çš„â€œå¥æŸ„â€ (Handle)ï¼Œæˆ–è€…æ˜¯ â€œå‡­è¯ IDâ€ã€‚
        //Linux å†…æ ¸é‡Œå¯èƒ½åŒæ—¶è¿è¡Œç€ QQã€å¾®ä¿¡ã€Nginxï¼Œå®ƒä»¬éƒ½åœ¨ç”¨ Epollã€‚å†…æ ¸é‡Œå¯èƒ½å¼€äº†å‡ åä¸ª Epoll å®ä¾‹ï¼ˆå‡ åå—é»‘æ¿ï¼‰ã€‚
        //æ¯ä¸ª Epoll å®ä¾‹éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ IDï¼Œå« epoll_fdã€‚ç¨‹åºå‘˜æ‹¿åˆ°è¿™ä¸ª IDï¼Œå°±èƒ½å¯¹è¿™ä¸ª Epoll å®ä¾‹è¿›è¡Œå„ç§æ“ä½œï¼ˆæ·»åŠ ç›‘å¬ã€åˆ é™¤ç›‘å¬ã€ç­‰å¾…äº‹ä»¶ç­‰ï¼‰ã€‚
        //ä½ å¿…é¡»å‘Šè¯‰å†…æ ¸ï¼šä½ çœ‹çš„æ˜¯å“ªä¸€å—é»‘æ¿ï¼
        //å¦‚æœè¿”å› -1ï¼Œè¯´æ˜å†…æ ¸æ²¡æœ‰å†…å­˜äº†ï¼Œæˆ–è€…å‡ºé”™äº†
        perror("Epoll create failed");
        exit(EXIT_FAILURE);
    }

    // --- 3. æ·»åŠ â€œè¿å®¾å‘˜â€ (Monitor Server Socket) ---
    
    struct epoll_event ev, events[MAX_EVENTS];
    //struct epoll_eventé‡Œæœ‰ä¸€ä¸ªè”åˆä½“ dataï¼Œå¯ä»¥å­˜æ”¾ç”¨æˆ·æ•°æ®
    //evæ˜¯ä½ å‘ç»™å†…æ ¸çš„é…ç½®å•ï¼ˆæˆ‘æƒ³è¦ç›‘å¬è°ï¼‰  epoll_ctl(..., &ev);
    //eventsæ˜¯æ˜¯å†…æ ¸å‘å›ç»™ä½ çš„ç»“æœå•ï¼ˆåˆšæ‰è°å‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼‰ epoll_wait(..., events, ...);
    
    ev.events = EPOLLIN; // ç›‘å¬â€œè¯»â€äº‹ä»¶ (æœ‰æ–°è¿æ¥ä¹Ÿç®—è¯»äº‹ä»¶)
    //EPOLLINï¼šè¡¨ç¤ºâ€œæœ‰æ•°æ®è¿›æ¥ (Input)â€ã€‚è¿™æ˜¯æœ€å¸¸ç”¨çš„äº‹ä»¶ã€‚
    //æ„å‘³ç€â€œæœ‰æ–°è¿æ¥è¿›æ¥äº†â€ï¼ˆæœ‰äººåœ¨æ•²é—¨ï¼Œä¸‰æ¬¡æ¡æ‰‹å®Œæˆäº†ï¼‰ã€‚
    //è¿æ¥ Socket çš„ç¼“å†²åŒºæœ‰ä¸œè¥¿ = æœ‰æ’é˜Ÿçš„æ•°æ® -> EPOLLIN
    ev.data.fd = server_fd; // æŠŠ server_fd è®°å½•ä¸‹æ¥
    // ã€åˆçº§éœ€æ±‚ã€‘int fd; æŠŠ fd (æ–‡ä»¶æè¿°ç¬¦) è¿˜ç»™ç¨‹åºå‘˜ï¼Œç¨‹åºå‘˜å°±çŸ¥é“æ˜¯å“ªä¸ª socket æœ‰äº‹äº†ã€‚
    // ã€é«˜çº§éœ€æ±‚ã€‘void *ptr; å­˜ä¸€ä¸ª ç»“æ„ä½“æŒ‡é’ˆï¼Œåœ¨è¿™ä¸ª socket ä¸Šç»‘å®šå¾ˆå¤šé¢å¤–ä¿¡æ¯
        //æ¯”å¦‚ï¼šè¿™ä¸ª socket æ˜¯ç”¨æ¥ä¼ å›¾ç‰‡çš„è¿˜æ˜¯ä¼ æ–‡å­—çš„ï¼Ÿå®ƒçš„è¯»å†™ç¼“å†²åŒºåœ¨å“ªé‡Œï¼Ÿï¼‰è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªè‡ªå®šä¹‰çš„å¤æ‚çš„ç»“æ„ä½“

            //struct MyContext *ctx = malloc(sizeof(struct MyContext));
            //ctx->fd = client_fd;
            //ctx->status = 1;
            //ev.data.ptr = ctx; // ğŸ‘ˆ é€‰æ‹©å¡«å…… Union é‡Œçš„ ptr æˆå‘˜

    //Union çš„å¦™å¤„ï¼š å†…æ ¸ç»™ä½ ç•™äº†è¿™ä¸ª data æ§½ä½ã€‚ä½ å¯ä»¥å­˜ intï¼Œä¹Ÿå¯ä»¥å­˜ ptrï¼Œåæ­£å®ƒä¿©å ç”¨çš„å†…å­˜ç©ºé—´æ˜¯é‡å çš„ï¼Œä¸ä¼šæµªè´¹å†…å­˜ã€‚
    
    // åŠ¨ä½œï¼šADD (æ·»åŠ åˆ°çº¢é»‘æ ‘)
    if (epoll_ctl(epoll_fd, EPOLL_CTL_ADD, server_fd, &ev) < 0) {
        //epoll_ctl() ç³»ç»Ÿè°ƒç”¨ç”¨äºæ§åˆ¶ Epoll å®ä¾‹çš„è¡Œä¸ºï¼Œæ¯”å¦‚æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ã€‚ã€äº‹ä»¶æ³¨å†Œä¸ç®¡ç†ã€‘
        //å¾ªç¯å¤–çš„ ctl = æŠŠâ€œè¿å®¾å‘˜â€çš„åå­—å†™ä¸Šå»ï¼ˆæ²¡æœ‰è¿™ä¸€æ­¥ï¼Œæ ¹æœ¬æ²¡äººçŸ¥é“æœ‰æ–°å®¢äººæ¥ï¼Œç¨‹åºå°±æ²¡æ³•å¯åŠ¨ï¼‰ã€‚
        perror("Epoll ctl failed");
        exit(EXIT_FAILURE);
    }



    // --- 4. è¿›å…¥ä¸»å¾ªç¯ (ç›‘è€ƒè€å¸ˆå¼€å§‹ç¡è§‰) ---
    while (1) {
        // ç­‰å¾…äº‹ä»¶å‘ç”Ÿ
        // å‚æ•° -1 è¡¨ç¤ºæ°¸ä¹…é˜»å¡ï¼Œç›´åˆ°æœ‰äº‹ä»¶å‘ç”Ÿæ‰é†’æ¥
        // è¿”å›å€¼ nfds æ˜¯â€œè¿™å°±äº¤å·åå•â€é‡Œçš„äººæ•°
        int nfds = epoll_wait(epoll_fd, events, MAX_EVENTS, -1);
        //epoll_wait() ç³»ç»Ÿè°ƒç”¨ç”¨äºç­‰å¾…å·²æ³¨å†Œçš„æ–‡ä»¶æè¿°ç¬¦ä¸Šå‘ç”Ÿçš„äº‹ä»¶ï¼Œå¹¶å°†è¿™äº›äº‹ä»¶è¿”å›ç»™ç”¨æˆ·æ€ç¨‹åºã€‚ã€é˜»å¡ç­‰å¾… + æ•°æ®æ‹·è´ã€‘
        
        if (nfds < 0) {
            perror("Epoll wait error");
            break;
        }

        // éå†æ‰€æœ‰å‘ç”Ÿçš„äº‹ä»¶ï¼ˆåªéå†è¿™å‡ ä¸ªæ´»è·ƒçš„äººï¼‰
        for (int i = 0; i < nfds; i++) {
            
            int current_fd = events[i].data.fd;

            // [Case A]ï¼š (ç›¸ç­‰)ï¼šè¯´æ˜æ˜¯è¿å®¾å‘˜ä¸¾æ‰‹äº†ã€‚è¿™æ„å‘³ç€æœ‰äººè¦å»ºç«‹æ–°è¿æ¥ï¼ˆä¸‰æ¬¡æ¡æ‰‹è¯·æ±‚ï¼‰ã€‚
            if (current_fd == server_fd) {
                if ((client_fd = accept(server_fd, (struct sockaddr *)&address, (socklen_t*)&addr_len)) < 0) {
                    perror("Accept failed");
                    continue;
                }
                
                printf("ğŸ‘‹ æ–°å®¢æˆ·ç«¯è¿æ¥! FD: %d\n", client_fd);

                // å…³é”®ä¸€æ­¥ï¼šæŠŠæ–°æ¥çš„å®¢äººä¹ŸåŠ å…¥ Epoll ç›‘æ§åå•ï¼
                ev.events = EPOLLIN; // åªè¦ä»–è¯´è¯(å‘æ•°æ®)ï¼Œå°±å«é†’æˆ‘.
                //æ„å‘³ç€â€œå¯¹æ–¹å‘æ•°æ®è¿‡æ¥äº†â€ï¼ˆç½‘çº¿ä¸Šä¼ æ¥äº†å­—èŠ‚æµï¼‰ã€‚
                //è¿æ¥ Socket çš„ç¼“å†²åŒºæœ‰ä¸œè¥¿ = æœ‰æ’é˜Ÿçš„æ•°æ® -> EPOLLIN
                ev.data.fd = client_fd;
                if (epoll_ctl(epoll_fd, EPOLL_CTL_ADD, client_fd, &ev) < 0) {
                    //å¾ªç¯å†…çš„ ctl = æŠŠâ€œæ–°è¿›æ¥çš„å®¢äººâ€çš„åå­—å†™ä¸Šå»ï¼ˆä¸ºäº†ä»¥åèƒ½æ”¶åˆ°ä»–ä»¬å‘çš„æ¶ˆæ¯ï¼‰ã€‚
                    //æ¯ accept ä¸€ä¸ªæ–°å®¢äººï¼Œå°±å¿…é¡»ç«‹åˆ»ç»™ä»–å¡«ä¸€å¼ è¡¨ï¼ŒæŠŠä»–åŠ å…¥ç›‘æ§åå•ã€‚ å¦åˆ™è¿™ä¸ªå®¢äººå°±æ˜¯ä¸ªâ€œå“‘å·´â€ã€‚
                    perror("Epoll ctl client failed");
                }
            } 
            // [Case B]ï¼š(ä¸ç›¸ç­‰)ï¼šè¯´æ˜æ˜¯ä¹‹å‰å·²ç»è¿›æ¥çš„æ™®é€šå®¢äººï¼ˆå·²è¿æ¥ Socketï¼‰ä¸¾æ‰‹äº†ã€‚è¿™æ„å‘³ç€æœ‰äººå‘æ•°æ®æ¥äº†ï¼ˆè¯¥å» read äº†ï¼‰ã€‚
            else {
                memset(buffer, 0, BUFFER_SIZE);
                int valread = read(current_fd, buffer, BUFFER_SIZE);

                if (valread <= 0) {
                    // å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ (è¿”å› 0) æˆ–å‡ºé”™ (è¿”å› -1)
                    printf("âŒ å®¢æˆ·ç«¯æ–­å¼€ (FD: %d)\n", current_fd);
                    
                    // 1. ä» Epoll æ ‘ä¸Šæ‘˜ä¸‹æ¥ (è™½ç„¶ close ä¼šè‡ªåŠ¨ç§»é™¤ï¼Œä½†æ˜¾å¼è°ƒç”¨æ˜¯å¥½ä¹ æƒ¯)
                    epoll_ctl(epoll_fd, EPOLL_CTL_DEL, current_fd, NULL);
                    // 2. å…³é—­è¿æ¥
                    close(current_fd);
                } else {
                    // æ­£å¸¸æ”¶åˆ°æ•°æ®ï¼Œå¤„ç†å›å£°
                    printf("ğŸ“© æ”¶åˆ° (FD:%d): %s", current_fd, buffer);
                    
                    // åŸæ ·å‘å›å»
                    char msg[BUFFER_SIZE + 50];
                    sprintf(msg, "Server: æˆ‘æ”¶åˆ°äº†ä½ çš„æ¶ˆæ¯ -> %s", buffer);
                    send(current_fd, msg, strlen(msg), 0);
                }
            }
        }
    }

    close(server_fd);
    close(epoll_fd);
    return 0;
}